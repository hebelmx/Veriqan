@page "/demo-admin"
@using ExxerCube.Prisma.Web.UI.Services
@inject DemoAdminService DemoAdminService
@inject IJSRuntime JS

<PageTitle>Demo Admin Panel</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning border-start border-warning border-4" role="alert">
                <h4 class="alert-heading d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Demo Administration - Use with Caution!
                </h4>
                <p class="mb-0">
                    This panel is for <strong>DEMO ENVIRONMENTS ONLY</strong>.
                    It performs <strong>HARD DELETES</strong> that cannot be undone.
                    <strong>NEVER</strong> use this in production!
                </p>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-database me-2"></i>
                        Current Database Statistics
                    </h5>
                </div>
                <div class="card-body">
                    @if (_isLoadingStats)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading statistics...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading database statistics...</p>
                        </div>
                    }
                    else if (_currentStats != null)
                    {
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="display-4 text-primary">@_currentStats.AuditRecordsCount</div>
                                    <div class="text-muted">Audit Records</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="display-4 text-info">@_currentStats.FileMetadataCount</div>
                                    <div class="text-muted">File Metadata</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                Last updated: @_currentStats.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                            </small>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-sm w-100" @onclick="LoadStatsAsync" disabled="@_isLoadingStats">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                Refresh Statistics
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-trash-fill me-2"></i>
                        Cleanup Operations
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger mb-3" role="alert">
                        <i class="bi bi-exclamation-octagon-fill me-2"></i>
                        <strong>Warning:</strong> This will permanently delete all demo data!
                    </div>

                    <div class="mb-3">
                        <p class="mb-2"><strong>What will be deleted:</strong></p>
                        <ul class="mb-0">
                            <li>All Audit Records (Event traceability data)</li>
                            <li>All File Metadata (Downloaded file records)</li>
                            <li>Identity seeds will be reset to 0</li>
                        </ul>
                    </div>

                    <div class="d-grid gap-2">
                        <button
                            class="btn btn-danger btn-lg"
                            @onclick="ConfirmAndCleanupAsync"
                            disabled="@_isCleaningUp">
                            @if (_isCleaningUp)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Cleaning Database...</span>
                            }
                            else
                            {
                                <i class="bi bi-trash3-fill me-2"></i>
                                <span>Clean Demo Database</span>
                            }
                        </button>

                        <button
                            class="btn btn-outline-secondary"
                            @onclick="LoadStatsAsync"
                            disabled="@_isCleaningUp">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Refresh Stats After Cleanup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (_cleanupResult != null)
    {
        <div class="row">
            <div class="col-12">
                <div class="alert @(_cleanupResult.Success ? "alert-success" : "alert-danger") border-start border-4 @(_cleanupResult.Success ? "border-success" : "border-danger")" role="alert">
                    <h5 class="alert-heading d-flex align-items-center">
                        @if (_cleanupResult.Success)
                        {
                            <i class="bi bi-check-circle-fill me-2 text-success"></i>
                            <span>Cleanup Completed Successfully!</span>
                        }
                        else
                        {
                            <i class="bi bi-x-circle-fill me-2 text-danger"></i>
                            <span>Cleanup Failed</span>
                        }
                    </h5>

                    <div class="mb-3">
                        <p class="mb-1"><strong>@_cleanupResult.Message</strong></p>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="bg-white p-2 rounded border">
                                <div class="text-muted small">Audit Records Deleted</div>
                                <div class="fw-bold">@_cleanupResult.AuditRecordsDeleted</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="bg-white p-2 rounded border">
                                <div class="text-muted small">File Metadata Deleted</div>
                                <div class="fw-bold">@_cleanupResult.FileMetadataDeleted</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="bg-white p-2 rounded border">
                                <div class="text-muted small">Duration</div>
                                <div class="fw-bold">@_cleanupResult.Duration.TotalSeconds.ToString("F2")s</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="bg-white p-2 rounded border">
                                <div class="text-muted small">Status</div>
                                <div class="fw-bold">@(_cleanupResult.Success ? "‚úì Success" : "‚úó Failed")</div>
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(_cleanupResult.ErrorMessage))
                    {
                        <div class="mt-3">
                            <strong>Error Details:</strong>
                            <pre class="bg-white p-2 rounded border mt-2 mb-0"><code>@_cleanupResult.ErrorMessage</code></pre>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Usage Instructions
                    </h5>
                </div>
                <div class="card-body">
                    <h6>Before Stakeholder Demo:</h6>
                    <ol>
                        <li>Click "Refresh Statistics" to see current data</li>
                        <li>Click "Clean Demo Database" button</li>
                        <li>Confirm the action in the popup dialog</li>
                        <li>Wait for cleanup to complete</li>
                        <li>Verify statistics show 0 records</li>
                        <li>Database is now ready for fresh demo run</li>
                    </ol>

                    <h6 class="mt-3">After Stakeholder Demo:</h6>
                    <ol>
                        <li>Run cleanup again to prepare for next demo</li>
                        <li>Verify all demo data is removed</li>
                    </ol>

                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-lightbulb-fill me-2"></i>
                        <strong>Tip:</strong> This is safer than running PowerShell scripts because:
                        <ul class="mb-0 mt-2">
                            <li>Transaction rollback on errors</li>
                            <li>Built-in confirmation dialog</li>
                            <li>Real-time feedback on operation status</li>
                            <li>No typos in SQL commands</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private DemoDataStats? _currentStats;
    private DemoCleanupResult? _cleanupResult;
    private bool _isLoadingStats = false;
    private bool _isCleaningUp = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatsAsync();
    }

    private async Task LoadStatsAsync()
    {
        _isLoadingStats = true;
        try
        {
            _currentStats = await DemoAdminService.GetDatabaseStatsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading stats: {ex.Message}");
        }
        finally
        {
            _isLoadingStats = false;
        }
    }

    private async Task ConfirmAndCleanupAsync()
    {
        // JavaScript confirmation dialog for safety
        var confirmed = await JS.InvokeAsync<bool>(
            "confirm",
            "‚ö†Ô∏è WARNING: This will PERMANENTLY DELETE all demo data!\n\n" +
            $"You are about to delete:\n" +
            $"- {_currentStats?.AuditRecordsCount ?? 0} Audit Records\n" +
            $"- {_currentStats?.FileMetadataCount ?? 0} File Metadata records\n\n" +
            "This action CANNOT be undone!\n\n" +
            "Are you sure you want to continue?");

        if (!confirmed)
        {
            return;
        }

        // Double confirmation for extra safety
        var doubleConfirmed = await JS.InvokeAsync<bool>(
            "confirm",
            "üö® FINAL CONFIRMATION REQUIRED üö®\n\n" +
            "This is your last chance to cancel!\n\n" +
            "Type 'YES' in the next prompt to proceed with deletion.");

        if (!doubleConfirmed)
        {
            return;
        }

        _isCleaningUp = true;
        _cleanupResult = null;

        try
        {
            _cleanupResult = await DemoAdminService.CleanDemoDataAsync();

            // Refresh stats after cleanup
            await LoadStatsAsync();
        }
        catch (Exception ex)
        {
            _cleanupResult = new DemoCleanupResult
            {
                Success = false,
                EndTime = DateTime.UtcNow,
                ErrorMessage = ex.Message,
                Message = $"Cleanup failed with exception: {ex.Message}",
            };
        }
        finally
        {
            _isCleaningUp = false;
        }
    }
}
