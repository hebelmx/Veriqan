@page "/browser-automation"
@using ExxerCube.Prisma.Domain.Interfaces
@using ExxerCube.Prisma.Domain
@using ExxerCube.Prisma.Domain.Enum
@using ExxerCube.Prisma.Infrastructure.BrowserAutomation
@using Microsoft.Extensions.Options
@using AngleSharp.Html.Parser
@using System.Diagnostics
@using Microsoft.JSInterop
@using Microsoft.Extensions.Logging
@inject IBrowserAutomationAgent BrowserAgent
@inject IOptions<BrowserAutomationOptions> BrowserOptions
@inject ISnackbar Snackbar
@inject ILogger<BrowserAutomationDemo> Logger
@implements IDisposable

<PageTitle>Browser Automation - Document Download</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-6" Elevation="3">
        <MudText Typo="Typo.h3" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Language" Class="mr-2" />
            Browser Automation - Document Download
        </MudText>
        <MudText Typo="Typo.body1" Class="mb-4">
            Automated browser navigation and document download from public sources using Playwright.
            This demonstrates the browser automation infrastructure for regulatory document collection.
        </MudText>

        <MudDivider Class="my-4" />

        <!-- Configuration Panel (Expandable) -->
        <MudExpansionPanels Class="mb-4">
            <MudExpansionPanel Text="Advanced Configuration (Edit for MVP Demo)">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_siaraUrl" Label="SIARA Simulator URL" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_gutenbergUrl" Label="Gutenberg Base URL" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_archiveUrl" Label="Internet Archive Base URL" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudNumericField @bind-Value="_browserTimeoutMs" Label="Browser Timeout (ms)" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudNumericField @bind-Value="_pageTimeoutMs" Label="Page Timeout (ms)" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>
            </MudExpansionPanel>
        </MudExpansionPanels>

        <!-- Controls -->
        <MudGrid Class="mb-4">
            <MudItem xs="12" md="4">
                <MudSelect T="string" @bind-Value="_selectedSource" Label="Document Source" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("gutenberg")">Project Gutenberg (Economics Books)</MudSelectItem>
                    <MudSelectItem Value="@("archive")">Internet Archive (Financial Markets)</MudSelectItem>
                    <MudSelectItem Value="@("siara")">SIARA Simulator (CNBV Dummies)</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudNumericField @bind-Value="_downloadCount" Label="Number of Files" Variant="Variant.Outlined"
                                 Min="1" Max="10" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSwitch @bind-Value="_showBrowser" Label="Show Browser (Headed Mode)" Color="Color.Primary" />
            </MudItem>
            <MudItem xs="12" md="2" Class="d-flex align-center">
                <MudChip T="string" Size="Size.Small" Color="@(_showBrowser ? Color.Success : Color.Default)">
                    @(_showBrowser ? "Visible" : "Headless")
                </MudChip>
            </MudItem>
        </MudGrid>

        <!-- SIARA Simulator Controls (only shown when SIARA is selected) -->
        @if (_selectedSource == "siara")
        {
            <MudPaper Class="pa-4 mb-4" Outlined="true">
                <MudText Typo="Typo.h6" GutterBottom="true">
                    <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" />
                    SIARA Simulator Service
                </MudText>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudButton Variant="Variant.Filled" Color="Color.Success"
                               OnClick="StartSimulator" Disabled="@(_isSimulatorRunning || _isSimulatorStarting)"
                               StartIcon="@Icons.Material.Filled.PlayArrow">
                        Start Simulator
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Error"
                               OnClick="StopSimulator" Disabled="@(!_isSimulatorRunning || _isSimulatorStopping)"
                               StartIcon="@Icons.Material.Filled.Stop">
                        Stop Simulator
                    </MudButton>
                    <MudChip T="string" Size="Size.Medium" Color="@(_isSimulatorRunning ? Color.Success : Color.Default)">
                        @(_isSimulatorRunning ? "Running" : "Stopped")
                    </MudChip>
                    @if (_isSimulatorStarting)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        <MudText Typo="Typo.body2">Starting...</MudText>
                    }
                    @if (_isSimulatorStopping)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        <MudText Typo="Typo.body2">Stopping...</MudText>
                    }
                </MudStack>
                <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
                    Simulator URL: @_siaraUrl
                </MudText>
            </MudPaper>
        }

        <MudStack Row="true" Spacing="2" Class="mb-6">
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       OnClick="StartDownload" Disabled="@_isDownloading"
                       StartIcon="@Icons.Material.Filled.Download">
                Start Download
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                       OnClick="ClearDownloads" Disabled="@_isDownloading"
                       StartIcon="@Icons.Material.Filled.Clear">
                Clear Downloads
            </MudButton>
        </MudStack>

        <!-- Progress Section -->
        @if (_isDownloading)
        {
            <MudPaper Class="pa-4 mb-4" Outlined="true">
                <MudText Typo="Typo.h6" GutterBottom="true">
                    <MudIcon Icon="@Icons.Material.Filled.CloudDownload" Class="mr-2" />
                    Download Progress
                </MudText>
                <MudProgressLinear Color="Color.Primary" Value="@_progressPercent" Class="my-4" />
                <MudText Typo="Typo.body2">
                    @_statusMessage
                </MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Downloaded: @_downloadedFiles.Count / @_downloadCount files
                </MudText>
            </MudPaper>
        }

        <!-- Downloaded Files List -->
        @if (_downloadedFiles.Any())
        {
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.h5" GutterBottom="true" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Class="mr-2" />
                Downloaded Files (@_downloadedFiles.Count)
            </MudText>

            <MudDataGrid T="DownloadedFile" Items="@_downloadedFiles" Hover="true" Dense="true">
                <Columns>
                    <PropertyColumn Property="x => x.FileName" Title="File Name" />
                    <PropertyColumn Property="x => x.Format" Title="Format" />
                    <TemplateColumn Title="Size">
                        <CellTemplate>
                            @FormatFileSize(context.Item.Content?.Length ?? 0)
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Source">
                        <CellTemplate>
                            <MudChip T="string" Size="Size.Small" Color="@GetSourceColor(context.Item.Url)">
                                @GetSourceName(context.Item.Url)
                            </MudChip>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Actions">
                        <CellTemplate>
                            <MudIconButton Icon="@Icons.Material.Filled.Info" Size="Size.Small"
                                           OnClick="@(() => ShowFileDetails(context.Item))" />
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        }
        else if (!_isDownloading)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">
                No files downloaded yet. Select a source and click "Start Download" to begin.
            </MudAlert>
        }
    </MudPaper>
</MudContainer>

@using ExxerCube.Prisma.Infrastructure.BrowserAutomation.NavigationTargets
@inject IOptions<NavigationTargetOptions> NavigationTargetOptions

@code {
    private string _selectedSource = "gutenberg";
    private int _downloadCount = 3;
    private bool _isDownloading = false;
    private bool _showBrowser = true; // Default to headed mode for demo visibility
    private int _progressPercent = 0;
    private string _statusMessage = "";
    private List<DownloadedFile> _downloadedFiles = new();

    // Editable configuration (initialized from appsettings.json)
    private string _siaraUrl = "";
    private string _gutenbergUrl = "";
    private string _archiveUrl = "";
    private int _browserTimeoutMs = 30000;
    private int _pageTimeoutMs = 30000;

    // SIARA Simulator process management
    private Process? _simulatorProcess;
    private bool _isSimulatorRunning = false;
    private bool _isSimulatorStarting = false;
    private bool _isSimulatorStopping = false;
    private bool _simulatorStartedByUI = false;

    // Gutenberg book IDs (from E2E tests)
    private readonly string[] _gutenbergBookIds = new[] { "3300", "30107", "1232" };

    protected override async Task OnInitializedAsync()
    {
        // Load configuration from appsettings.json
        _siaraUrl = NavigationTargetOptions.Value.SiaraUrl ?? "http://localhost:5001";
        _gutenbergUrl = NavigationTargetOptions.Value.GutenbergUrl ?? "https://www.gutenberg.org";
        _archiveUrl = NavigationTargetOptions.Value.ArchiveUrl ?? "https://archive.org";
        _browserTimeoutMs = BrowserOptions.Value.BrowserLaunchTimeoutMs;
        _pageTimeoutMs = BrowserOptions.Value.PageTimeoutMs;

        // Check if SIARA simulator is already running
        _isSimulatorRunning = await IsSimulatorRunningAsync();
    }

    private async Task StartDownload()
    {
        _isDownloading = true;
        _progressPercent = 0;
        _statusMessage = _showBrowser ? "Launching browser in headed mode (visible)..." : "Launching browser in headless mode...";
        StateHasChanged();

        // Declare customAgent before try block so it's accessible in finally
        IBrowserAutomationAgent? customAgent = null;

        try
        {
            // Create custom browser agent with headed/headless mode based on toggle and editable config
            var customOptions = new BrowserAutomationOptions
            {
                Headless = !_showBrowser, // Invert: showBrowser=true means Headless=false
                BrowserLaunchTimeoutMs = _browserTimeoutMs,
                PageTimeoutMs = _pageTimeoutMs
            };
            var customOptionsWrapper = Microsoft.Extensions.Options.Options.Create(customOptions);
            customAgent = new PlaywrightBrowserAutomationAdapter(
                Microsoft.Extensions.Logging.Abstractions.NullLogger<PlaywrightBrowserAutomationAdapter>.Instance,
                customOptionsWrapper);

            // Launch browser with custom options
            var launchResult = await customAgent.LaunchBrowserAsync();
            if (!launchResult.IsSuccess)
            {
                Snackbar.Add($"Failed to launch browser: {launchResult.Error}", Severity.Error);
                return;
            }

            _statusMessage = _showBrowser ? "Browser launched in headed mode (you should see it!)" : "Browser launched in headless mode";
            StateHasChanged();

            _statusMessage = "Browser launched successfully";
            StateHasChanged();

            if (_selectedSource == "gutenberg")
            {
                await DownloadFromGutenberg(customAgent);
            }
            else if (_selectedSource == "archive")
            {
                await NavigateToArchive(customAgent);
            }
            else if (_selectedSource == "siara")
            {
                await NavigateToSiara(customAgent);
            }

            Snackbar.Add($"Downloaded {_downloadedFiles.Count} files successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            // Close browser if it was created
            if (customAgent != null)
            {
                await customAgent.CloseBrowserAsync();
            }
            _isDownloading = false;
            _progressPercent = 100;
            StateHasChanged();
        }
    }

    private async Task DownloadFromGutenberg(IBrowserAutomationAgent agent)
    {
        var booksToDownload = _gutenbergBookIds.Take(_downloadCount);
        var totalBooks = booksToDownload.Count();
        var currentBook = 0;

        foreach (var bookId in booksToDownload)
        {
            currentBook++;
            _statusMessage = $"Processing book {currentBook}/{totalBooks} (ID: {bookId})...";
            _progressPercent = (currentBook - 1) * 100 / totalBooks;
            StateHasChanged();

            // Navigate to book page (use editable URL)
            var bookUrl = $"{_gutenbergUrl}/ebooks/{bookId}";
            var navResult = await agent.NavigateToAsync(bookUrl);

            if (!navResult.IsSuccess)
            {
                Snackbar.Add($"Failed to navigate to book {bookId}", Severity.Warning);
                continue;
            }

            await Task.Delay(1000); // Small delay for visibility

            // Download plain text format (most reliable) - use editable URL
            var txtUrl = $"{_gutenbergUrl}/cache/epub/{bookId}/pg{bookId}.txt";
            _statusMessage = $"Downloading plain text for book {bookId}...";
            StateHasChanged();

            var downloadResult = await agent.DownloadFileAsync(txtUrl);
            if (downloadResult.IsSuccess && downloadResult.Value != null)
            {
                _downloadedFiles.Add(downloadResult.Value);
                Snackbar.Add($"Downloaded: {downloadResult.Value.FileName}", Severity.Success);
            }

            await Task.Delay(500);
        }

        _progressPercent = 100;
    }

    private async Task NavigateToArchive(IBrowserAutomationAgent agent)
    {
        _statusMessage = "Navigating to Internet Archive (demo only - downloads restricted)...";
        StateHasChanged();

        var archiveUrl = $"{_archiveUrl}/search.php?query=financial%20markets";
        var navResult = await agent.NavigateToAsync(archiveUrl);

        if (navResult.IsSuccess)
        {
            _statusMessage = "Successfully navigated to Internet Archive search results";
            Snackbar.Add("Internet Archive has restricted downloads. Use Gutenberg for demo.", Severity.Info);
        }

        await Task.Delay(3000); // Show page for 3 seconds
        _progressPercent = 100;
    }

    private async Task NavigateToSiara(IBrowserAutomationAgent agent)
    {
        _statusMessage = "Navigating to SIARA Simulator (CNBV document simulator)...";
        StateHasChanged();

        // Use editable SIARA URL
        _statusMessage = $"Connecting to SIARA at {_siaraUrl}...";
        StateHasChanged();

        var navResult = await agent.NavigateToAsync(_siaraUrl);

        if (!navResult.IsSuccess)
        {
            _statusMessage = $"Failed to connect to SIARA: {navResult.Error}";
            Snackbar.Add($"SIARA connection failed. Make sure SIARA Simulator is running at {_siaraUrl}", Severity.Warning);
            _progressPercent = 100;
            return;
        }

        _statusMessage = "Connected to SIARA - performing login...";
        StateHasChanged();

        // Wait for login form to load
        var waitResult = await agent.WaitForSelectorAsync("#username", 10000);
        if (!waitResult.IsSuccess)
        {
            _statusMessage = "Login form not found - SIARA may already be logged in or unavailable";
            Snackbar.Add("Could not find login form", Severity.Warning);
            _progressPercent = 100;
            return;
        }

        await Task.Delay(1000);

        // Fill username field (any username works in demo mode)
        _statusMessage = "Entering credentials...";
        StateHasChanged();

        var fillUsernameResult = await agent.FillInputAsync("#username", "BancoDemo");
        if (!fillUsernameResult.IsSuccess)
        {
            _statusMessage = $"Failed to fill username: {fillUsernameResult.Error}";
            Snackbar.Add("Login failed at username field", Severity.Error);
            _progressPercent = 100;
            return;
        }

        await Task.Delay(500);

        // Fill password field (any password works in demo mode)
        var fillPasswordResult = await agent.FillInputAsync("#password", "demo123");
        if (!fillPasswordResult.IsSuccess)
        {
            _statusMessage = $"Failed to fill password: {fillPasswordResult.Error}";
            Snackbar.Add("Login failed at password field", Severity.Error);
            _progressPercent = 100;
            return;
        }

        await Task.Delay(500);

        // Click login button
        _statusMessage = "Clicking login button...";
        StateHasChanged();

        var clickResult = await agent.ClickElementAsync("button[type='submit']");
        if (!clickResult.IsSuccess)
        {
            _statusMessage = $"Failed to click login: {clickResult.Error}";
            Snackbar.Add("Login button click failed", Severity.Error);
            _progressPercent = 100;
            return;
        }

        // Wait for dashboard to load after login
        _statusMessage = "Logging in... waiting for dashboard...";
        StateHasChanged();
        await Task.Delay(5000); // Match test: PostLoginWaitMs = 5000

        _statusMessage = "Successfully logged in! Viewing dashboard for 3 seconds...";
        Snackbar.Add("SIARA login successful - simulator running!", Severity.Success);
        StateHasChanged();
        await Task.Delay(3000); // Match test: pause to view dashboard

        // Watch SIARA for a period (like the test does - 3 minutes, but we'll use shorter for demo)
        _statusMessage = "Watching SIARA dashboard as cases arrive...";
        SafeStateHasChanged();

        try
        {
            await Task.Delay(TimeSpan.FromMinutes(3)); // Match test: watch for 3 minutes
        }
        catch (TaskCanceledException)
        {
            Logger.LogInformation("SIARA watch period cancelled - user likely navigated away");
            return;
        }

        _statusMessage = "Watch period complete. Collecting documents from page...";
        _progressPercent = 50;
        SafeStateHasChanged();

        // STEP: Collect Documents using AngleSharp + HttpClient (matches test approach)
        try
        {
            using var httpClient = new HttpClient();

            // Fetch HTML from dashboard
            _statusMessage = "Fetching dashboard HTML...";
            SafeStateHasChanged();
            var html = await httpClient.GetStringAsync($"{_siaraUrl}/");

            // Parse HTML with AngleSharp
            var parser = new HtmlParser();
            var document = await parser.ParseDocumentAsync(html);

            // Find all document links (PDF, DOCX, XML)
            var docLinks = document.QuerySelectorAll("a[href$='.pdf'], a[href$='.docx'], a[href$='.xml']")
                .Select(a => a.GetAttribute("href"))
                .Where(href => !string.IsNullOrEmpty(href))
                .Select(href => href!.StartsWith("http") ? href : $"{_siaraUrl}{href}")
                .Distinct()
                .ToList();

            _statusMessage = $"Found {docLinks.Count} document links in HTML";
            SafeStateHasChanged();
            SafeSnackbarAdd($"Found {docLinks.Count} documents!", Severity.Success);

            if (!docLinks.Any())
            {
                _statusMessage = "No documents found on dashboard";
                SafeSnackbarAdd("No SIARA documents found. Simulator may not have generated any cases yet.", Severity.Warning);
                _progressPercent = 100;
                return;
            }

            // Download documents
            var linksToDownload = docLinks.Take(_downloadCount).ToList();
            _statusMessage = $"Downloading {linksToDownload.Count} documents...";
            SafeStateHasChanged();

            const int maxConcurrentDownloads = 3;
            for (int i = 0; i < linksToDownload.Count; i += maxConcurrentDownloads)
            {
                var batch = linksToDownload.Skip(i).Take(maxConcurrentDownloads).ToList();
                var downloadTasks = batch.Select(async link =>
                {
                    var fileName = Path.GetFileName(link);

                    _statusMessage = $"Downloading {fileName}...";
                    SafeStateHasChanged();

                    var bytes = await httpClient.GetByteArrayAsync(link);

                    var downloadedFile = new DownloadedFile
                    {
                        FileName = fileName,
                        Content = bytes,
                        Url = link,
                        Format = DetermineFileFormat(fileName)
                    };

                    _downloadedFiles.Add(downloadedFile);
                    SafeSnackbarAdd($"Downloaded: {fileName}", Severity.Success);
                });

                await Task.WhenAll(downloadTasks);

                _progressPercent = 50 + ((i + maxConcurrentDownloads) * 50 / linksToDownload.Count);
                SafeStateHasChanged();

                if (i + maxConcurrentDownloads < linksToDownload.Count)
                {
                    await Task.Delay(300);
                }
            }

            _statusMessage = $"Successfully downloaded {_downloadedFiles.Count(f => f.Url.Contains(_siaraUrl))} SIARA documents";
            _progressPercent = 100;
            SafeStateHasChanged();
        }
        catch (JSDisconnectedException ex)
        {
            Logger.LogInformation(ex, "Circuit disconnected during SIARA document collection");
            // User navigated away - this is fine, just stop processing
        }
        catch (Exception ex)
        {
            _statusMessage = $"Error collecting documents: {ex.Message}";
            Logger.LogError(ex, "Error collecting SIARA documents");
            SafeSnackbarAdd($"Failed to collect documents: {ex.Message}", Severity.Error);
            _progressPercent = 100;
        }
    }

    private FileFormat DetermineFileFormat(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLowerInvariant();
        return extension switch
        {
            ".pdf" => FileFormat.Pdf,
            ".xml" => FileFormat.Xml,
            ".docx" => FileFormat.Docx,
            ".zip" => FileFormat.Zip,
            _ => FileFormat.Pdf
        };
    }

    private void ClearDownloads()
    {
        _downloadedFiles.Clear();
        _progressPercent = 0;
        _statusMessage = "";
        Snackbar.Add("Download list cleared", Severity.Info);
    }

    private void ShowFileDetails(DownloadedFile file)
    {
        Snackbar.Add($"File: {file.FileName}, Size: {FormatFileSize(file.Content?.Length ?? 0)}, Format: {file.Format}",
                     Severity.Info);
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024:F1} KB";
        return $"{bytes / (1024 * 1024):F2} MB";
    }

    private Color GetSourceColor(string url)
    {
        if (url.Contains("gutenberg")) return Color.Primary;
        if (url.Contains("archive.org")) return Color.Secondary;
        if (url.Contains("localhost:5001") || url.Contains("localhost:5002") || url.Contains("siara")) return Color.Success;
        return Color.Default;
    }

    private string GetSourceName(string url)
    {
        if (url.Contains("gutenberg")) return "Gutenberg";
        if (url.Contains("archive.org")) return "Archive";
        if (url.Contains("localhost:5001") || url.Contains("localhost:5002") || url.Contains("siara")) return "SIARA";
        return "Unknown";
    }

    // ========== SIARA Simulator Process Management ==========

    /// <summary>
    /// Gets the path to the SIARA Simulator executable.
    /// Searches from current directory up to solution root.
    /// </summary>
    private static string GetSimulatorPath()
    {
        // Start from current directory (web app location)
        var currentDir = Directory.GetCurrentDirectory();

        // Find solution root by looking for Deployments folder
        var searchDir = new DirectoryInfo(currentDir);
        while (searchDir != null)
        {
            // Check if we found the solution root (has Deployments folder)
            var deploymentsPath = Path.Combine(searchDir.FullName, "Deployments", "Siara.Simulator", "app", "Siara.Simulator.exe");
            if (File.Exists(deploymentsPath))
            {
                return deploymentsPath;
            }

            // Move up one directory
            searchDir = searchDir.Parent;
        }

        // Fallback: construct from typical structure
        return Path.GetFullPath(
            Path.Combine(
                currentDir,
                "..", "..", "..", "..", "..", "..",
                "Deployments", "Siara.Simulator", "app", "Siara.Simulator.exe"));
    }

    /// <summary>
    /// Checks if the SIARA Simulator is running.
    /// </summary>
    private async Task<bool> IsSimulatorRunningAsync()
    {
        try
        {
            using var httpClient = new HttpClient { Timeout = TimeSpan.FromSeconds(2) };
            var response = await httpClient.GetAsync(_siaraUrl);
            return response.IsSuccessStatusCode;
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// Starts the SIARA Simulator executable.
    /// </summary>
    private async Task StartSimulator()
    {
        _isSimulatorStarting = true;
        StateHasChanged();

        try
        {
            var simulatorExePath = GetSimulatorPath();

            // Verify the executable exists
            if (!File.Exists(simulatorExePath))
            {
                Snackbar.Add($"Simulator executable not found at: {simulatorExePath}", Severity.Error);
                return;
            }

            // Start the simulator process
            var startInfo = new ProcessStartInfo
            {
                FileName = simulatorExePath,
                WorkingDirectory = Path.GetDirectoryName(simulatorExePath),
                UseShellExecute = false,
                CreateNoWindow = false, // Show window so user can see it running
                RedirectStandardOutput = false,
                RedirectStandardError = false
            };

            _simulatorProcess = Process.Start(startInfo);
            if (_simulatorProcess == null)
            {
                Snackbar.Add("Failed to start simulator process", Severity.Error);
                return;
            }

            _simulatorStartedByUI = true;
            Snackbar.Add($"Simulator process started (PID: {_simulatorProcess.Id})", Severity.Info);

            // Wait for simulator to be ready (max 20 seconds)
            var maxAttempts = 40; // 40 attempts * 500ms = 20 seconds
            var attempt = 0;
            while (attempt < maxAttempts)
            {
                await Task.Delay(500);
                if (await IsSimulatorRunningAsync())
                {
                    _isSimulatorRunning = true;
                    Snackbar.Add($"SIARA Simulator is ready at {_siaraUrl}", Severity.Success);
                    return;
                }
                attempt++;
            }

            Snackbar.Add($"Simulator started but not responding on {_siaraUrl} after 20 seconds", Severity.Warning);
            _isSimulatorRunning = false;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error starting simulator: {ex.Message}", Severity.Error);
            _isSimulatorRunning = false;
        }
        finally
        {
            _isSimulatorStarting = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Stops the SIARA Simulator if it was started by the UI.
    /// </summary>
    private async Task StopSimulator()
    {
        _isSimulatorStopping = true;
        StateHasChanged();

        try
        {
            if (_simulatorStartedByUI && _simulatorProcess != null)
            {
                if (!_simulatorProcess.HasExited)
                {
                    _simulatorProcess.Kill(entireProcessTree: true);
                    _simulatorProcess.WaitForExit(5000); // Wait up to 5 seconds
                    Snackbar.Add("Simulator stopped successfully", Severity.Success);
                }
                _simulatorProcess.Dispose();
                _simulatorProcess = null;
            }
            else
            {
                Snackbar.Add("Cannot stop simulator - it was not started by this page", Severity.Warning);
            }

            _isSimulatorRunning = false;
            _simulatorStartedByUI = false;

            // Double check if it's really stopped
            await Task.Delay(1000);
            _isSimulatorRunning = await IsSimulatorRunningAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error stopping simulator: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSimulatorStopping = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Safely calls StateHasChanged, catching JSDisconnectedException when circuit is disconnected.
    /// </summary>
    private void SafeStateHasChanged()
    {
        try
        {
            StateHasChanged();
        }
        catch (JSDisconnectedException ex)
        {
            // Circuit disconnected (user closed browser, network issue, etc.)
            // This is expected behavior - log and continue
            Logger.LogDebug(ex, "SignalR circuit disconnected - user likely navigated away");
        }
        catch (ObjectDisposedException ex)
        {
            // Component already disposed
            Logger.LogDebug(ex, "Component disposed during StateHasChanged");
        }
    }

    /// <summary>
    /// Safely shows a snackbar message, catching JSDisconnectedException.
    /// </summary>
    private void SafeSnackbarAdd(string message, Severity severity)
    {
        try
        {
            Snackbar.Add(message, severity);
        }
        catch (JSDisconnectedException ex)
        {
            Logger.LogDebug(ex, "Cannot show snackbar - circuit disconnected: {Message}", message);
        }
        catch (ObjectDisposedException ex)
        {
            Logger.LogDebug(ex, "Cannot show snackbar - component disposed: {Message}", message);
        }
    }

    /// <summary>
    /// Cleanup resources when page is disposed.
    /// Stops simulator if it was started by the UI.
    /// </summary>
    public void Dispose()
    {
        // Stop simulator if we started it
        if (_simulatorStartedByUI && _simulatorProcess != null)
        {
            try
            {
                if (!_simulatorProcess.HasExited)
                {
                    _simulatorProcess.Kill(entireProcessTree: true);
                    _simulatorProcess.WaitForExit(5000);
                }
            }
            catch (Exception ex)
            {
                // Log but don't throw during disposal
                Logger.LogWarning(ex, "Error stopping simulator during disposal");
            }
            finally
            {
                _simulatorProcess?.Dispose();
            }
        }
    }
}
