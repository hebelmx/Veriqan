[tox]
envlist = py{39,310,311}-{unit,integration,e2e}, coverage, lint, security, docs
skip_missing_interpreters = true
isolated_build = true

[testenv]
deps = 
    -r{toxinidir}/requirements.txt
    -r{toxinidir}/requirements-test.txt

[testenv:py{39,310,311}-unit]
commands = 
    pytest tests/unit/ \
        --cov=src \
        --cov-report=xml \
        --cov-report=term-missing \
        --cov-fail-under=80 \
        -v \
        --tb=short \
        -m "unit and not slow"

[testenv:py{39,310,311}-integration]
commands = 
    python tests/data/fixtures/generate_test_fixtures.py
    pytest tests/integration/ \
        --cov=src \
        --cov-append \
        --cov-report=xml \
        --cov-report=term-missing \
        -v \
        --tb=short \
        -m "integration and mock"

[testenv:py{39,310,311}-e2e]
commands = 
    python tests/data/fixtures/generate_test_fixtures.py
    pytest tests/e2e/ \
        --cov=src \
        --cov-append \
        --cov-report=xml \
        --cov-report=term-missing \
        -v \
        --tb=short \
        -m "e2e and mock"

[testenv:performance]
basepython = python3.11
commands = 
    python tests/data/fixtures/generate_test_fixtures.py
    pytest tests/performance/ \
        --benchmark-json=benchmark.json \
        -v \
        -m "performance and not slow"

[testenv:coverage]
basepython = python3.11
deps = 
    {[testenv]deps}
    coverage[toml]
commands = 
    python tests/data/fixtures/generate_test_fixtures.py
    pytest tests/ \
        --cov=src \
        --cov-report=html \
        --cov-report=xml \
        --cov-report=term \
        --cov-fail-under=75 \
        -m "unit or (integration and mock) or (e2e and mock)"

[testenv:lint]
deps = 
    black
    isort
    flake8
    mypy
commands = 
    black --check src/ tests/
    isort --check-only src/ tests/
    flake8 src/ tests/
    mypy src/ --ignore-missing-imports

[testenv:format]
deps = 
    black
    isort
commands = 
    black src/ tests/
    isort src/ tests/

[testenv:security]
deps = 
    bandit[toml]
    safety
commands = 
    bandit -r src/ -ll
    safety check --json

[testenv:docs]
deps = 
    sphinx
    sphinx-rtd-theme
    myst-parser
changedir = docs
commands = 
    sphinx-build -W -b html source build/html

[testenv:clean]
deps = coverage
commands = 
    coverage erase
    python -c "
    import shutil
    import pathlib
    dirs = ['.pytest_cache', 'htmlcov', '.coverage*', '__pycache__']
    for d in dirs:
        for path in pathlib.Path('.').rglob(d):
            if path.is_dir():
                shutil.rmtree(path, ignore_errors=True)
            elif path.is_file():
                path.unlink(missing_ok=True)
    "

# Test environments for different scenarios
[testenv:test-quick]
basepython = python3.11
commands = 
    pytest tests/unit/ -v -m "unit and not slow" --tb=short --maxfail=5

[testenv:test-all]
basepython = python3.11
commands = 
    python tests/data/fixtures/generate_test_fixtures.py
    pytest tests/ \
        --cov=src \
        --cov-report=term \
        -v \
        -m "unit or (integration and mock) or (e2e and mock)"

[testenv:test-slow]
basepython = python3.11
commands = 
    python tests/data/fixtures/generate_test_fixtures.py
    pytest tests/ \
        -v \
        -m "slow or performance" \
        --tb=short

[testenv:test-real]
# For testing with real models (not mocked)
basepython = python3.11
commands = 
    python tests/data/fixtures/generate_test_fixtures.py
    pytest tests/integration/ tests/e2e/ \
        -v \
        -m "not mock" \
        --tb=short \
        --maxfail=2
passenv = 
    CUDA_VISIBLE_DEVICES
    HF_TOKEN
    TRANSFORMERS_CACHE

[flake8]
max-line-length = 88
extend-ignore = E203, W503, E501
exclude = 
    .git,
    __pycache__,
    .tox,
    .venv,
    venv,
    build,
    dist,
    *.egg-info

[coverage:run]
source = src
omit = 
    */tests/*
    */test_*
    */conftest.py
    */__init__.py

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    if self.debug:
    if settings.DEBUG
    raise AssertionError
    raise NotImplementedError
    if 0:
    if __name__ == .__main__.:
    class .*\bProtocol\):
    @(abc\.)?abstractmethod

[coverage:html]
directory = htmlcov

[coverage:xml]
output = coverage.xml