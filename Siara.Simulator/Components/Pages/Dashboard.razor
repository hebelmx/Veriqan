@page "/"
@rendermode InteractiveServer
@inject Siara.Simulator.Services.CaseService CaseService
@inject ILogger<Dashboard> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>SIARA - Bandeja de Requerimientos</PageTitle>

<div id="particles-js"></div>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h3>Bandeja de Requerimientos de Autoridad (Simulaci贸n)</h3>
        <p>Nuevos requerimientos aparecer谩n autom谩ticamente.</p>
    </div>

    <div class="simulation-controls">
        <div class="control-group">
            <label for="arrivalRateSlider">
                Tasa de Llegada: <strong>@_arrivalRate.ToString("F1")</strong> casos/minuto
            </label>
            <input
                type="range"
                id="arrivalRateSlider"
                class="form-range"
                min="0.1"
                max="60"
                step="0.1"
                value="@_arrivalRate"
                @oninput="OnArrivalRateChanged" />
            <small class="form-text text-muted">
                Distribuci贸n: Poisson (tiempo entre llegadas exponencial)
            </small>
        </div>
        <div class="control-group">
            <button class="btn btn-warning btn-reset" @onclick="OnResetSimulation">
                 Reiniciar Simulaci贸n
            </button>
            <small class="form-text text-muted">
                Limpia todos los casos y reinicia la simulaci贸n desde cero
            </small>
        </div>
    </div>

    <div class="case-list">
        @if (!_cases.Any())
        {
            <div class="no-cases">
                <p>No hay requerimientos en la bandeja. Esperando nuevas llegadas...</p>
            </div>
        }
        else
        {
            <table class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>Folio SIARA (ID de Caso)</th>
                        <th>Fecha de Llegada</th>
                        <th>Estatus</th>
                        <th>Documentos</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var c in _cases)
                    {
                        <tr>
                            <td>@c.Id</td>
                            <td>@c.ArrivalTimestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td><span class="badge bg-primary">@c.Status</span></td>
                            <td>
                                <a href="@c.PdfPath" target="_blank" class="btn btn-sm btn-outline-danger">PDF</a>
                                <a href="@c.DocxPath" target="_blank" class="btn btn-sm btn-outline-primary">DOCX</a>
                                <a href="@c.XmlPath" target="_blank" class="btn btn-sm btn-outline-secondary">XML</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<style>
    #particles-js {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: -1;
        background: linear-gradient(135deg, #006847 0%, #004830 100%);
    }

    .dashboard-container {
        position: relative;
        z-index: 1;
    }

    .dashboard-header, .simulation-controls, .case-list {
        background-color: rgba(255, 255, 255, 0.95);
        padding: 20px;
        margin: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .dashboard-header {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 215, 0, 0.1));
        border-left: 5px solid #FFD700;
    }

    .simulation-controls {
        background-color: rgba(255, 255, 255, 0.98);
        border-left: 5px solid #006847;
    }

    .case-list table {
        table-layout: auto;
    }

    .case-list table th:first-child,
    .case-list table td:first-child {
        width: 35%;
        min-width: 280px;
        font-weight: 500;
        color: #006847;
    }

    .case-list table th:nth-child(2),
    .case-list table td:nth-child(2) {
        width: 20%;
        white-space: nowrap;
    }

    .case-list table th:nth-child(3),
    .case-list table td:nth-child(3) {
        width: 15%;
        text-align: center;
    }

    .case-list table th:nth-child(4),
    .case-list table td:nth-child(4) {
        width: 30%;
        text-align: center;
    }

    .control-group {
        margin-bottom: 15px;
    }

    .btn-reset {
        width: 100%;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
    }

    .btn-reset:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 152, 0, 0.5);
    }

    .btn-reset:active {
        transform: translateY(0);
    }
</style>

@code {
    private IEnumerable<Siara.Simulator.Models.Case> _cases = new List<Siara.Simulator.Models.Case>();
    private double _arrivalRate = 6.0;
    private IDisposable? _caseArrivedSubscription;
    private IDisposable? _settingsChangedSubscription;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Logger.LogInformation("Initializing particles.js background");
            try
            {
                // Use the custom helper function that ensures particles.js is loaded
                await JSRuntime.InvokeVoidAsync("initializeParticles");
                Logger.LogInformation("particles.js initialized successfully");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error initializing particles.js");
            }
        }
    }

    protected override void OnInitialized()
    {
        Logger.LogInformation("Dashboard.OnInitialized called");

        // Subscribe to observables
        _caseArrivedSubscription = CaseService.CaseArrived.Subscribe(
            onNext: newCase =>
            {
                Logger.LogInformation("Dashboard received new case notification - Case ID: {CaseId}", newCase.Id);
                _ = InvokeAsync(() =>
                {
                    _cases = CaseService.GetActiveCases();
                    Logger.LogInformation("Dashboard now has {Count} cases", _cases.Count());
                    StateHasChanged();
                    Logger.LogInformation("StateHasChanged called successfully");
                });
            },
            onError: ex =>
            {
                Logger.LogError(ex, "Error in CaseArrived observable");
            });

        _settingsChangedSubscription = CaseService.SettingsChanged.Subscribe(
            onNext: unit =>
            {
                Logger.LogInformation("Dashboard received settings change notification");
                _ = InvokeAsync(() =>
                {
                    _arrivalRate = CaseService.AverageArrivalsPerMinute;
                    StateHasChanged();
                    Logger.LogInformation("Settings updated and StateHasChanged called");
                });
            },
            onError: ex =>
            {
                Logger.LogError(ex, "Error in SettingsChanged observable");
            });

        Logger.LogInformation("Dashboard subscribed to CaseService observables");

        // Start the simulation (deferred from app startup)
        CaseService.Start();

        // Load initial cases and settings
        _cases = CaseService.GetActiveCases();
        _arrivalRate = CaseService.AverageArrivalsPerMinute;

        Logger.LogInformation("Dashboard initialized with {Count} cases", _cases.Count());
    }

    private void OnArrivalRateChanged(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out var newRate))
        {
            _arrivalRate = newRate;
            CaseService.AverageArrivalsPerMinute = newRate;
        }
    }

    private void OnResetSimulation()
    {
        Logger.LogInformation("Reset simulation button clicked");

        // Reset the case service
        CaseService.Reset();    

        // Update the UI
        _cases = CaseService.GetActiveCases();
        StateHasChanged();

        Logger.LogInformation("Simulation reset complete");
    }

    public void Dispose()
    {
        Logger.LogInformation("Dashboard.Dispose - disposing observable subscriptions and particles");

        // Dispose subscriptions to prevent memory leaks
        _caseArrivedSubscription?.Dispose();
        _settingsChangedSubscription?.Dispose();

        // Cleanup particles.js
        try
        {
            JSRuntime.InvokeVoidAsync("destroyParticles");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error destroying particles.js");
        }
    }
}
