# Story 1.10: SignalR Unified Hub Abstraction Infrastructure

**Status:** Draft  
**Epic:** 1 - Regulatory Compliance Automation System  
**Stage:** Infrastructure / Cross-Stage  
**Created:** 2025-01-15  
**Priority:** High (Required before UI enhancements in Stories 1.1-1.3)

---

## Story

**As a** system architect,  
**I want** a unified SignalR hub abstraction infrastructure with reusable components (`ExxerHub<T>`, `ServiceHealth<T>`, `Dashboard<T>`),  
**so that** all real-time UI components (document ingestion dashboard, classification results, field matching views) can leverage consistent, maintainable real-time communication patterns without duplicating SignalR connection logic.

---

## Acceptance Criteria

1. System provides generic `ExxerHub<T>` abstraction for SignalR hubs following hexagonal architecture principles
2. System provides `ServiceHealth<T>` abstraction for monitoring service health status with real-time updates
3. System provides `Dashboard<T>` abstraction for dashboard components requiring real-time data updates
4. All abstractions are packaged in a reusable library/package independent of ExxerAI project dependencies
5. Abstractions support dependency injection and follow clean architecture patterns
6. Abstractions include comprehensive unit tests and integration tests
7. Abstractions support connection management (reconnection, error handling, connection state tracking)
8. Abstractions support message batching and throttling for high-frequency updates
9. Abstractions are documented with usage examples and architectural decision records (ADR-017)
10. Package structure separates concerns: Hub abstractions, Health monitoring, Dashboard components

---

## Integration Verification

- **IV1:** Abstractions integrate seamlessly with existing MudBlazor components
- **IV2:** Abstractions do not introduce breaking changes to existing SignalR implementations
- **IV3:** Abstractions support Blazor Server hosting model requirements
- **IV4:** Package can be referenced independently without ExxerAI project dependencies

---

## Tasks / Subtasks

### Phase 1: Package Structure and Foundation

- [ ] Create new package project structure (AC: 4, 10)
  - [ ] Create `ExxerCube.Prisma.SignalR.Abstractions` project in solution
  - [ ] Remove/isolate ExxerAI project dependencies
  - [ ] Configure project for NuGet package creation
  - [ ] Set up project references and dependencies (SignalR, Blazor Server)
- [ ] Create ADR-017 document (AC: 9)
  - [ ] Document architectural decision for unified hub abstraction
  - [ ] Document hexagonal architecture approach
  - [ ] Document design patterns and rationale
  - [ ] Include usage examples and integration patterns

### Phase 2: Core Abstractions

- [ ] Implement `ExxerHub<T>` generic abstraction (AC: 1, 5, 7)
  - [ ] Create `IExxerHub<T>` interface in `Abstractions/Hubs/`
  - [ ] Create `ExxerHub<T>` base class implementing `Hub`
  - [ ] Implement connection management (OnConnectedAsync, OnDisconnectedAsync)
  - [ ] Implement reconnection logic and error handling
  - [ ] Implement connection state tracking
  - [ ] Support dependency injection for hub services
- [ ] Implement `ServiceHealth<T>` abstraction (AC: 2, 5, 7)
  - [ ] Create `IServiceHealth<T>` interface in `Abstractions/Health/`
  - [ ] Create `ServiceHealth<T>` class for health status monitoring
  - [ ] Implement health status change notifications
  - [ ] Implement real-time health updates via SignalR
  - [ ] Support multiple health check types (liveness, readiness, custom)
- [ ] Implement `Dashboard<T>` abstraction (AC: 3, 5, 7, 8)
  - [ ] Create `IDashboard<T>` interface in `Abstractions/Dashboards/`
  - [ ] Create `Dashboard<T>` base component for Blazor components
  - [ ] Implement SignalR connection management in component lifecycle
  - [ ] Implement message batching and throttling
  - [ ] Implement automatic reconnection on connection loss
  - [ ] Support multiple data update patterns (push, pull, hybrid)

### Phase 3: Connection Management and Resilience

- [ ] Implement connection state management (AC: 7)
  - [ ] Create `ConnectionState` enum (Connecting, Connected, Disconnected, Reconnecting, Failed)
  - [ ] Implement connection state change events
  - [ ] Implement connection state UI indicators
  - [ ] Add connection retry logic with exponential backoff
- [ ] Implement error handling and recovery (AC: 7)
  - [ ] Create error handling middleware for hub methods
  - [ ] Implement error event notifications
  - [ ] Add error recovery strategies
  - [ ] Log connection errors and recovery attempts
- [ ] Implement message throttling and batching (AC: 8)
  - [ ] Create message queue for high-frequency updates
  - [ ] Implement batching logic (time-based, count-based)
  - [ ] Implement throttling to prevent UI overload
  - [ ] Add configuration for batch size and throttle intervals

### Phase 4: Blazor Component Integration

- [ ] Create Blazor Server integration components (AC: 3, IV1, IV3)
  - [ ] Create `DashboardComponent<T>` base Razor component
  - [ ] Implement SignalR HubConnection management in component lifecycle
  - [ ] Create connection state display component
  - [ ] Create error display component
  - [ ] Integrate with MudBlazor components for UI consistency
- [ ] Create helper extensions and utilities (AC: 5)
  - [ ] Create DI extension methods for service registration
  - [ ] Create configuration extension methods
  - [ ] Create helper methods for common SignalR patterns
  - [ ] Create extension methods for MudBlazor integration

### Phase 5: Testing Infrastructure

- [ ] Write unit tests for core abstractions (AC: 6)
  - [ ] Test `ExxerHub<T>` connection management
  - [ ] Test `ServiceHealth<T>` health status updates
  - [ ] Test `Dashboard<T>` component lifecycle
  - [ ] Test connection state transitions
  - [ ] Test error handling and recovery
  - [ ] Test message batching and throttling logic
- [ ] Write integration tests (AC: 6, IV2, IV3)
  - [ ] Test end-to-end SignalR communication
  - [ ] Test Blazor Server component integration
  - [ ] Test reconnection scenarios
  - [ ] Test high-frequency update handling
  - [ ] Test multiple concurrent connections
- [ ] Create test utilities and helpers (AC: 6)
  - [ ] Create mock SignalR hub for testing
  - [ ] Create test fixtures for common scenarios
  - [ ] Create test data builders

### Phase 6: Documentation and Examples

- [ ] Create comprehensive documentation (AC: 9)
  - [ ] Document `ExxerHub<T>` usage patterns
  - [ ] Document `ServiceHealth<T>` integration
  - [ ] Document `Dashboard<T>` component usage
  - [ ] Create API reference documentation
  - [ ] Document configuration options
- [ ] Create usage examples (AC: 9)
  - [ ] Example: Document ingestion dashboard with real-time updates
  - [ ] Example: Service health monitoring dashboard
  - [ ] Example: Classification results with live updates
  - [ ] Example: Field matching view with real-time progress
  - [ ] Include code samples and integration guides
- [ ] Update ADR-017 with implementation details (AC: 9)
  - [ ] Document final implementation decisions
  - [ ] Document trade-offs and alternatives considered
  - [ ] Document performance characteristics
  - [ ] Document known limitations

### Phase 7: Package Preparation

- [ ] Clean ExxerAI project dependencies (AC: 4, IV4)
  - [ ] Audit all dependencies in abstraction package
  - [ ] Remove ExxerAI-specific dependencies
  - [ ] Replace with generic alternatives where needed
  - [ ] Verify package can be used independently
- [ ] Configure NuGet package metadata (AC: 4)
  - [ ] Set package ID, version, description
  - [ ] Configure package tags and metadata
  - [ ] Create package README
  - [ ] Set up package versioning strategy
- [ ] Create package build and publish pipeline (AC: 4)
  - [ ] Configure CI/CD for package building
  - [ ] Configure automated testing in pipeline
  - [ ] Configure package publishing (local/private feed)

---

## Dev Notes

### Architecture Context

**Hexagonal Architecture Approach:**
- Core abstractions are domain-agnostic and framework-agnostic where possible
- SignalR-specific implementations are in infrastructure layer
- Blazor-specific implementations are in presentation layer
- Clear separation of concerns: Hub logic, Connection management, UI components

**Package Structure:**
```
ExxerCube.Prisma.SignalR.Abstractions/
├── Abstractions/
│   ├── Hubs/
│   │   ├── IExxerHub.cs
│   │   └── ExxerHub.cs
│   ├── Health/
│   │   ├── IServiceHealth.cs
│   │   └── ServiceHealth.cs
│   └── Dashboards/
│       ├── IDashboard.cs
│       └── Dashboard.cs
├── Infrastructure/
│   ├── Connection/
│   │   ├── ConnectionState.cs
│   │   ├── ConnectionManager.cs
│   │   └── ReconnectionStrategy.cs
│   └── Messaging/
│       ├── MessageBatcher.cs
│       └── MessageThrottler.cs
├── Presentation/
│   └── Blazor/
│       ├── DashboardComponent.cs
│       ├── ConnectionStateIndicator.cs
│       └── ErrorDisplay.cs
├── Extensions/
│   ├── ServiceCollectionExtensions.cs
│   └── MudBlazorExtensions.cs
└── Tests/
    ├── Unit/
    ├── Integration/
    └── Helpers/
```

**Technology Stack:**
- .NET 10
- ASP.NET Core SignalR
- Blazor Server
- MudBlazor (for UI components)
- xUnit v3 (for testing)
- NSubstitute (for mocking)

**Design Patterns:**
- Generic Repository Pattern (for hub abstractions)
- Strategy Pattern (for reconnection strategies)
- Observer Pattern (for health status updates)
- Template Method Pattern (for dashboard components)

### Integration Points

**With Existing System:**
- Integrates with existing SignalR infrastructure
- Extends existing hub implementations
- Works alongside existing MudBlazor components
- Compatible with existing DI container configuration

**Future Integration (Stories 1.1-1.3 UI Enhancements):**
- `DocumentIngestionDashboard` will use `Dashboard<FileMetadata>`
- `ClassificationResultsCard` will use `Dashboard<ClassificationResult>`
- `FieldMatchingView` will use `Dashboard<MatchedFields>`
- All will leverage `ServiceHealth<T>` for monitoring

### Configuration

**appsettings.json:**
```json
{
  "SignalR": {
    "Abstractions": {
      "Reconnection": {
        "MaxRetries": 5,
        "InitialDelay": 1000,
        "MaxDelay": 30000,
        "BackoffMultiplier": 2.0
      },
      "Messaging": {
        "BatchSize": 50,
        "BatchInterval": 1000,
        "ThrottleInterval": 100
      },
      "Connection": {
        "Timeout": 30000,
        "KeepAliveInterval": 15000
      }
    }
  }
}
```

### Dependencies

**Required:**
- ASP.NET Core SignalR
- Blazor Server
- MudBlazor (for UI components)

**To Remove (ExxerAI Dependencies):**
- Any ExxerAI-specific packages
- Any ExxerAI-specific domain models
- Any ExxerAI-specific infrastructure

**Replacements:**
- Use generic types and interfaces
- Use standard .NET types where possible
- Create minimal abstractions for required functionality

### Testing Strategy

**Unit Tests:**
- Test each abstraction independently
- Mock SignalR dependencies
- Test connection state transitions
- Test error handling scenarios
- Test message batching/throttling logic

**Integration Tests:**
- Test with real SignalR hub
- Test with Blazor Server components
- Test reconnection scenarios
- Test concurrent connections
- Test high-frequency updates

**Performance Tests:**
- Test message throughput
- Test connection scalability
- Test memory usage with many connections
- Test CPU usage during high-frequency updates

---

## Related Documentation

- [ADR-017: Unified Hub Abstraction - Hexagonal Architecture](docs/adr/ADR-017-Unified-Hub-Abstraction-Hexagonal-Architecture.md) - Architectural decision record
- [Story 1.1: Browser Automation](../stories/1.1.browser-automation-document-download.md) - Will use Dashboard<FileMetadata>
- [Story 1.2: Metadata Extraction](../stories/1.2.enhanced-metadata-extraction-classification.md) - Will use Dashboard<ClassificationResult>
- [Story 1.3: Field Matching](../stories/1.3.field-matching-unified-metadata.md) - Will use Dashboard<MatchedFields>
- [UI Enhancements: Stories 1.1-1.3](../qa/ui-enhancements-stories-1.1-1.3-bmad.md) - UI specifications requiring this infrastructure

---

## Success Criteria

- [ ] Package can be referenced independently without ExxerAI dependencies
- [ ] All three abstractions (`ExxerHub<T>`, `ServiceHealth<T>`, `Dashboard<T>`) are implemented and tested
- [ ] Documentation and examples are complete
- [ ] ADR-017 is finalized
- [ ] Package is ready for use in Stories 1.1-1.3 UI enhancements
- [ ] All tests pass (unit, integration, performance)
- [ ] Code review completed and approved

---

**Story Status:** ✅ **Draft Complete**  
**Ready for:** Product Owner Review → Architecture Review → Development

